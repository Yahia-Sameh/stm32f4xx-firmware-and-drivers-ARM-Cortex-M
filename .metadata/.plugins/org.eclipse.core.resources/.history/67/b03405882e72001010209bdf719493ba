#include "led_matrix.h"

void LEDMX_Init(LED_Matrix* matrix) {
    // Initialize variables
    matrix->current_row = 0;
    matrix->brightness = 100; // 100% brightness

    // Clear the buffer
    LEDMX_Clear(matrix);

    // Initialize all rows as outputs (set to low)
    for (int i = 0; i < MATRIX_ROWS; i++) {
        // Enable GPIO clock if needed (done in main init)
        matrix->row_ports[i]->MODER &= ~(0x3 << (2 * matrix->row_pins[i]));
        matrix->row_ports[i]->MODER |= (0x1 << (2 * matrix->row_pins[i])); // Output mode
        matrix->row_ports[i]->OTYPER &= ~(1 << matrix->row_pins[i]); // Push-pull
        matrix->row_ports[i]->OSPEEDR |= (0x3 << (2 * matrix->row_pins[i])); // High speed
        matrix->row_ports[i]->ODR &= ~(1 << matrix->row_pins[i]); // Set low
    }

    // Initialize all columns as outputs (set to high)
    for (int i = 0; i < MATRIX_COLS; i++) {
        // Enable GPIO clock if needed (done in main init)
        matrix->col_ports[i]->MODER &= ~(0x3 << (2 * matrix->col_pins[i]));
        matrix->col_ports[i]->MODER |= (0x1 << (2 * matrix->col_pins[i])); // Output mode
        matrix->col_ports[i]->OTYPER &= ~(1 << matrix->col_pins[i]); // Push-pull
        matrix->col_ports[i]->OSPEEDR |= (0x3 << (2 * matrix->col_pins[i])); // High speed
        matrix->col_ports[i]->ODR |= (1 << matrix->col_pins[i]); // Set high
    }
}

void LEDMX_Clear(LED_Matrix* matrix) {
    for (int i = 0; i < MATRIX_ROWS; i++) {
        matrix->buffer[i] = 0x00;
    }
}

void LEDMX_SetPixel(LED_Matrix* matrix, uint8_t x, uint8_t y, uint8_t state) {
    if (x >= MATRIX_COLS || y >= MATRIX_ROWS) return;

    if (state) {
        matrix->buffer[y] |= (1 << x);
    } else {
        matrix->buffer[y] &= ~(1 << x);
    }
}

void LEDMX_Refresh(LED_Matrix* matrix) {
    // Turn off current row
    matrix->row_ports[matrix->current_row]->ODR &= ~(1 << matrix->row_pins[matrix->current_row]);

    // Move to next row
    matrix->current_row = (matrix->current_row + 1) % MATRIX_ROWS;

    // Set columns for new row
    for (int col = 0; col < MATRIX_COLS; col++) {
        if (matrix->buffer[matrix->current_row] & (1 << col)) {
            matrix->col_ports[col]->ODR &= ~(1 << matrix->col_pins[col]); // Active low
        } else {
            matrix->col_ports[col]->ODR |= (1 << matrix->col_pins[col]);
        }
    }

    // Enable new row
    matrix->row_ports[matrix->current_row]->ODR |= (1 << matrix->row_pins[matrix->current_row]);
}

void LEDMX_LoadFrame(LED_Matrix* matrix, const uint8_t frame[MATRIX_ROWS]) {
    for (int i = 0; i < MATRIX_ROWS; i++) {
        matrix->buffer[i] = frame[i];
    }
}
